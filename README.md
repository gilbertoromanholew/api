# üöÄ API Modular - Node.js & Express

[![Node.js](https://img.shields.io/badge/Node.js-22.18.0+-339933?logo=node.js&logoColor=white)](https://nodejs.org/)
[![Express](https://img.shields.io/badge/Express-5.1.0-000000?logo=express&logoColor=white)](https://expressjs.com/)
[![Version](https://img.shields.io/badge/Version-2.1.0-blue.svg)](https://github.com/gilbertoromanholew/api)
[![License](https://img.shields.io/badge/License-MIT-blue.svg)](LICENSE)
[![Status](https://img.shields.io/badge/Status-Online-success.svg)](https://api.samm.host)

> **API REST modular com auto-descoberta de rotas, valida√ß√£o centralizada, dashboard de monitoramento em tempo real, sistema de bloqueio autom√°tico de IPs e templates para desenvolvimento r√°pido.**

**üåê URL de Produ√ß√£o:** https://api.samm.host

**üìö Documenta√ß√£o Adicional:**
- üõ°Ô∏è [Sistema de Bloqueio de IPs](./SISTEMA_BLOQUEIO.md) - Documenta√ß√£o t√©cnica completa
- üìä [Implementa√ß√£o do Sistema](./IMPLEMENTACAO_BLOQUEIO.md) - Resumo executivo
- üîç [Auditoria Completa](./AUDITORIA_COMPLETA.md) - Relat√≥rio de auditoria do c√≥digo

---

## üìã √çndice

- [Caracter√≠sticas](#-caracter√≠sticas)
- [Instala√ß√£o](#-instala√ß√£o)
- [In√≠cio R√°pido](#-in√≠cio-r√°pido)
- [Arquitetura](#-arquitetura)
- [Endpoints Dispon√≠veis](#-endpoints-dispon√≠veis)
- [Dashboard Interativo](#-dashboard-interativo)
- [Como Criar Nova Funcionalidade](#-como-criar-nova-funcionalidade)
- [Configura√ß√£o](#-configura√ß√£o)
- [Seguran√ßa](#-seguran√ßa)
  - [Sistema de Bloqueio Autom√°tico](#Ô∏è-sistema-de-bloqueio-autom√°tico-de-ips)
- [Performance & Otimiza√ß√µes](#-performance--otimiza√ß√µes)
- [ZeroTier VPN - Acesso Seguro](#-zerotier-vpn---acesso-seguro)
- [Novas Implementa√ß√µes](#-novas-implementa√ß√µes-v210)
- [Estrutura do Projeto](#-estrutura-do-projeto)
- [Licen√ßa](#-licen√ßa)

---

## ‚ú® Caracter√≠sticas

### üèóÔ∏è Arquitetura & Desenvolvimento
- üéØ **Arquitetura Modular** - Funcionalidades independentes e auto-descobertas
- ‚ö° **Auto-carregamento de Rotas** - Descobre e registra rotas automaticamente
- üõ°Ô∏è **Valida√ß√£o Centralizada** - Sistema de schemas reutiliz√°veis
- üé® **Respostas Padronizadas** - BaseController para consist√™ncia
- üì¶ **Sistema de Templates** - Crie novas funcionalidades em 5 minutos
- üåê **CORS Habilitado** - Pronto para APIs p√∫blicas
- üö¶ **Tratamento Global de Erros** - Error handler centralizado

### üìä Monitoramento & Documenta√ß√£o
- üìù **Documenta√ß√£o Autom√°tica Interativa** (`/docs`)
  - Interface limpa com se√ß√µes colaps√°veis
  - Detec√ß√£o autom√°tica de IP p√∫blico
  - Cards de fun√ß√µes clic√°veis com exemplos integrados
  - Explorador de API embutido para testes diretos
  - Exemplos de c√≥digo em m√∫ltiplas linguagens
  
- üéØ **Dashboard de Logs em Tempo Real** (`/logs`)
  - M√©tricas gerais (requisi√ß√µes, uptime, IPs √∫nicos)
  - Cards de m√©tricas expans√≠veis (top 3 + ver todos)
  - Estat√≠sticas detalhadas por IP com geolocaliza√ß√£o completa
  - Modal com detalhes de IP e auto-refresh (3s)
  - Detec√ß√£o e pinning do seu IP no topo da lista
  - Logs de acesso recentes com filtros (colaps√°vel por padr√£o)
  - Pagina√ß√£o inteligente (12 IPs vis√≠veis + expandir)
  - Sistema de cache de geolocaliza√ß√£o (24h TTL)
  - Interface escal√°vel para 100+ IPs

### üîí Seguran√ßa & Performance
- üîê **Controle de Acesso por IP com CIDR** - Whitelist inteligente com suporte a ranges
- üõ°Ô∏è **Sistema de Bloqueio Autom√°tico** - Suspens√µes tempor√°rias e bloqueios permanentes
  - Suspens√£o de 1 hora ap√≥s 5 tentativas n√£o autorizadas
  - Bloqueio permanente ap√≥s 10 tentativas ou 3 suspens√µes
  - Dashboard visual para gerenciamento em tempo real
  - API REST para consulta e administra√ß√£o de bloqueios
- üåç **Geolocaliza√ß√£o Completa** (ip-api.com - 24+ campos):
  - Pa√≠s, cidade, regi√£o, CEP, timezone, coordenadas
  - ISP, organiza√ß√£o, AS (Sistema Aut√¥nomo)
  - Flags de hospedagem, proxy/VPN, rede m√≥vel
  - Cache de 24h para performance
- ‚ö° **Cache Inteligente** - Rotas descobertas (5min), geolocaliza√ß√£o (24h)
- üìä **Logs Otimizados** - Estat√≠sticas O(n) em vez de O(n¬≤)
- üîê **Suporte a ZeroTier VPN** - Acesso seguro via rede virtual criptografada
- üè† **Detec√ß√£o de Origem** - Identifica localhost, ZeroTier, LAN e WAN

---

## üîß Instala√ß√£o

### Pr√©-requisitos

- **Node.js** >= 22.18.0
- **npm** >= 10.x

### Passos

1. **Clone o reposit√≥rio:**

```bash
git clone https://github.com/gilbertoromanholew/api.git
cd api
```

2. **Instale as depend√™ncias:**

```bash
npm install
```

3. **Configure as vari√°veis de ambiente (opcional):**

```bash
cp .env.example .env
# Edite o arquivo .env conforme necess√°rio
```

4. **Inicie o servidor:**

```bash
npm start
```

5. **Acesse a API:**

```
http://localhost:3000
```

---

## üöÄ In√≠cio R√°pido

### Testar a Documenta√ß√£o

```bash
# Ver documenta√ß√£o JSON
curl http://localhost:3000/

# Acessar documenta√ß√£o HTML interativa
curl http://localhost:3000/docs
```

### Exemplo: Criar Usu√°rio

```bash
# Request
curl -X POST http://localhost:3000/usuarios \
  -H "Content-Type: application/json" \
  -d '{
    "nome": "Jo√£o Silva",
    "email": "joao@example.com",
    "idade": 30,
    "ativo": true
  }'

# Response
{
  "success": true,
  "data": {
    "id": "1",
    "nome": "Jo√£o Silva",
    "email": "joao@example.com",
    "idade": 30,
    "ativo": true
  }
}
```

### Exemplo: Extrair Texto de PDF

```bash
# Request
curl -X POST http://localhost:3000/read-pdf \
  -H "Content-Type: multipart/form-data" \
  -F "pdf=@documento.pdf"

# Response
{
  "success": true,
  "data": {
    "text": "Conte√∫do extra√≠do do PDF...",
    "pages": 5
  }
}
```

---

## üèóÔ∏è Arquitetura

### Auto-carregamento de Rotas

O sistema de **auto-descoberta** escaneia a pasta `src/functions/` e registra automaticamente todas as rotas:

```
src/functions/
  ‚îú‚îÄ‚îÄ exemplo/
  ‚îÇ   ‚îú‚îÄ‚îÄ exemploController.js  ‚Üê L√≥gica de neg√≥cio
  ‚îÇ   ‚îî‚îÄ‚îÄ exemploRoutes.js      ‚Üê Defini√ß√£o de rotas
  ‚îî‚îÄ‚îÄ pdf/
      ‚îú‚îÄ‚îÄ pdfController.js
      ‚îî‚îÄ‚îÄ pdfRoutes.js
```

**Como funciona:**
1. O `routeLoader.js` busca recursivamente por arquivos `*Routes.js`
2. Cada arquivo de rotas √© automaticamente importado e registrado
3. Novas funcionalidades s√£o detectadas sem reiniciar o servidor

### BaseController

Todos os controllers herdam de `BaseController` para garantir respostas padronizadas:

```javascript
class ExemploController extends BaseController {
  async criarUsuario(req, res) {
    const { nome, email, idade, ativo } = req.body;
    
    // Valida√ß√£o j√° foi feita pelo middleware
    const novoUsuario = {
      id: Date.now().toString(),
      nome,
      email,
      idade,
      ativo: ativo ?? true
    };
    
    return this.created(res, novoUsuario);
  }
}
```

**M√©todos dispon√≠veis:**
- `success(res, data)` - 200 OK
- `created(res, data)` - 201 Created
- `badRequest(res, message)` - 400 Bad Request
- `unauthorized(res, message)` - 401 Unauthorized
- `forbidden(res, message)` - 403 Forbidden
- `notFound(res, message)` - 404 Not Found
- `serverError(res, error)` - 500 Internal Server Error

---

## üìö Endpoints Dispon√≠veis

### üè† Root & Documenta√ß√£o

| M√©todo | Endpoint | Descri√ß√£o |
|--------|----------|-----------|
| `GET` | `/` | Informa√ß√µes completas da API (JSON) |
| `GET` | `/docs` | Documenta√ß√£o interativa (HTML) |
| `GET` | `/logs` | Dashboard de logs em tempo real (HTML) |

### üîê ZeroTier & Status

| M√©todo | Endpoint | Descri√ß√£o |
|--------|----------|-----------|
| `GET` | `/zerotier/status` | Status da rede ZeroTier VPN |
| `GET` | `/zerotier/devices` | Dispositivos conectados (info) |

### üìä API de Logs

| M√©todo | Endpoint | Descri√ß√£o |
|--------|----------|-----------|
| `GET` | `/api/logs` | Todos os logs (JSON) |
| `GET` | `/api/logs/stats` | Estat√≠sticas gerais (JSON) |
| `GET` | `/api/logs/ips` | Estat√≠sticas por IP (JSON) |
| `POST` | `/api/logs/clear` | Limpar todos os logs |
| `GET` | `/api/functions` | Fun√ß√µes auto-descobertas (cache 5min) |

### üë• Usu√°rios (CRUD Completo)

| M√©todo | Endpoint | Descri√ß√£o |
|--------|----------|-----------|
| `GET` | `/usuarios` | Lista todos os usu√°rios |
| `GET` | `/usuarios/estatisticas` | Estat√≠sticas dos usu√°rios |
| `GET` | `/usuarios/:id` | Busca usu√°rio por ID |
| `POST` | `/usuarios` | Cria novo usu√°rio |
| `PUT` | `/usuarios/:id` | Atualiza usu√°rio existente |
| `DELETE` | `/usuarios/:id` | Remove usu√°rio |

**Exemplo de corpo para criar usu√°rio:**
```json
{
  "nome": "Jo√£o Silva",
  "email": "joao@example.com",
  "idade": 30,
  "ativo": true
}
```

**Filtros dispon√≠veis na listagem (`GET /usuarios`):**
- `?ativo=true` - Filtra por status
- `?nome=Jo√£o` - Busca por nome
- `?email=joao@example.com` - Busca por email

### üìÑ PDF

| M√©todo | Endpoint | Descri√ß√£o |
|--------|----------|-----------|
| `POST` | `/read-pdf` | Extrai texto de arquivos PDF |

**Requisi√ß√£o com arquivo:**
```bash
curl -X POST http://localhost:3000/read-pdf \
  -F "pdf=@documento.pdf"
```

---

## üé® Como Criar Nova Funcionalidade

### Usando o Template

1. **Copie a pasta template:**

```bash
cp -r src/functions/_TEMPLATE src/functions/minhaFuncao
```

2. **Renomeie os arquivos:**

```bash
cd src/functions/minhaFuncao
mv templateController.js minhaFuncaoController.js
mv templateRoutes.js minhaFuncaoRoutes.js
```

3. **Edite o Controller:**

```javascript
// minhaFuncaoController.js
const BaseController = require('../../core/BaseController');

class MinhaFuncaoController extends BaseController {
  async executar(req, res) {
    try {
      const { parametro } = req.body;
      
      // Sua l√≥gica aqui
      const resultado = this.processar(parametro);
      
      return this.success(res, resultado);
    } catch (error) {
      return this.serverError(res, error);
    }
  }
  
  processar(parametro) {
    // Implementa√ß√£o
    return { resultado: 'sucesso' };
  }
}

module.exports = new MinhaFuncaoController();
```

4. **Configure as Rotas:**

```javascript
// minhaFuncaoRoutes.js
const express = require('express');
const router = express.Router();
const controller = require('./minhaFuncaoController');
const { validate, schemas } = require('../../middlewares/validator');

router.post('/processar', 
  validate(schemas.minhaFuncao),
  (req, res) => controller.executar(req, res)
);

module.exports = router;
```

5. **Reinicie o servidor** - A nova rota ser√° detectada automaticamente!

```bash
npm start
```

6. **Teste sua nova funcionalidade:**

```bash
curl -X POST http://localhost:3000/minhaFuncao/processar \
  -H "Content-Type: application/json" \
  -d '{"parametro": "teste"}'
```

### Estrutura M√≠nima Obrigat√≥ria

Para que o auto-carregamento funcione, voc√™ precisa:

‚úÖ **Arquivo de Rotas** (`*Routes.js`)
```javascript
const express = require('express');
const router = express.Router();
module.exports = router;
```

‚úÖ **Arquivo de Controller** (`*Controller.js`)
```javascript
const BaseController = require('../../core/BaseController');
class MeuController extends BaseController {}
module.exports = new MeuController();
```

---

## üéØ Dashboard Interativo

### üìù Documenta√ß√£o Interativa (`/docs`)

Acesse **http://localhost:3000/docs** para uma experi√™ncia completa:

#### Recursos Principais:
- üìä **Estat√≠sticas em Tempo Real**
  - Total de requisi√ß√µes
  - Requisi√ß√µes autorizadas
  - IPs √∫nicos conectados
  - Uptime do servidor (atualiza a cada segundo)

- üîí **Informa√ß√µes de Acesso** (Colaps√°vel)
  - Detec√ß√£o autom√°tica do seu **IP p√∫blico real**
  - Status de autoriza√ß√£o
  - Informa√ß√µes de seguran√ßa
  - User-Agent detectado

- üîë **Sistema de Autentica√ß√£o** (Colaps√°vel)
  - Explica√ß√£o do filtro de IP
  - Como configurar IPs autorizados
  - Exemplos de configura√ß√£o

- üì¶ **Fun√ß√µes Dispon√≠veis** (Se√ß√£o Principal)
  - Cards interativos e clic√°veis
  - Hover com anima√ß√£o de eleva√ß√£o
  - **Ao clicar em uma fun√ß√£o:**
    - üì° Exemplos de uso aparecem dinamicamente
    - ÔøΩ Explorador de API aparece para teste direto
    - Exemplos em JavaScript, Python, cURL
    - Teste endpoints com body customizado
    - Resposta formatada em JSON
  - Toast notifications para feedback
  - Scroll suave autom√°tico

#### Vantagens:
- ‚úÖ Interface ultra-limpa sem scroll infinito
- ‚úÖ Conte√∫do sob demanda (clique para expandir)
- ‚úÖ Teste de API integrado
- ‚úÖ Exemplos de c√≥digo prontos para copiar
- ‚úÖ Zero redund√¢ncia - tudo em um s√≥ lugar

---

## üìä Dashboard de Logs (`/logs`)

Acesse **http://localhost:3000/logs** para monitoramento avan√ßado:

#### Estat√≠sticas Gerais (Auto-refresh 10s)
- ‚úÖ **Total de Requisi√ß√µes** - Contador global
- ‚úîÔ∏è **Requisi√ß√µes Autorizadas** - Acessos permitidos
- üåç **IPs √önicos** - Contagem de visitantes diferentes
- ‚è±Ô∏è **Uptime do Servidor** - Tempo online

#### Cards de M√©tricas Expans√≠veis
Cada card mostra **Top 3** + bot√£o "Ver todos":
- üî• **Endpoints Mais Acessados**
- üåê **Navegadores Mais Usados** (Chrome, Firefox, Edge, Safari, etc.)
- üíª **Plataformas Mais Usadas** (Windows, Linux, macOS, Android, etc.)
- üåç **Pa√≠ses Mais Frequentes** (com bandeiras)

#### Estat√≠sticas Detalhadas por IP
- üè† **Seu IP fixado no topo** com badge "VOC√ä" e borda verde
- **Pagina√ß√£o inteligente:** 12 IPs vis√≠veis + bot√£o "Ver todos"
- **Cards com informa√ß√µes ricas:**
  - Endere√ßo IP + bandeira do pa√≠s
  - Total de requisi√ß√µes
  - Primeira e √∫ltima requisi√ß√£o
  - Navegador e plataforma
  - Bot√£o para ver detalhes completos

#### Modal de Detalhes de IP (Auto-refresh 3s)
Ao clicar em um IP, veja:
- üåç **Geolocaliza√ß√£o Completa:**
  - Pa√≠s, cidade, regi√£o/estado, CEP
  - Timezone com rel√≥gio
  - Coordenadas geogr√°ficas (link para Google Maps)
  
- üåê **Informa√ß√µes de Rede:**
  - ISP (Provedor de Internet)
  - Organiza√ß√£o propriet√°ria
  - AS (Sistema Aut√¥nomo)
  - Badges de alerta: üè¢ Hospedagem, üîí Proxy/VPN, üì± Rede M√≥vel

- üìä **Estat√≠sticas de Acesso:**
  - Total de requisi√ß√µes
  - Requisi√ß√µes autorizadas vs negadas
  - Endpoints acessados
  - Navegadores usados
  - Plataformas detectadas

- ÔøΩ **Logs Detalhados (Expans√≠vel):**
  - Hor√°rio preciso de cada acesso
  - Endpoint requisitado
  - Status de autoriza√ß√£o
  - Navegador e plataforma

#### Se√ß√£o de Logs Recentes (Colaps√°vel)
**Reduzida por padr√£o** - Clique no t√≠tulo para expandir:
- Tabela com √∫ltimos acessos
- **Filtros din√¢micos:**
  - Limite de registros (padr√£o: 50)
  - Tipo de acesso (todos, autorizados, negados)
  - Filtros aplicam automaticamente (sem bot√£o)
- Pagina√ß√£o "Ver mais" para carregar incrementalmente

#### Sistema de Geolocaliza√ß√£o Avan√ßado
- **24+ campos da ip-api.com:**
  - Localiza√ß√£o: pa√≠s, cidade, regi√£o, CEP, timezone, coordenadas
  - Rede: ISP, organiza√ß√£o, AS (Sistema Aut√¥nomo)
  - Seguran√ßa: flags de hospedagem, proxy, VPN, rede m√≥vel
- **Cache inteligente:** 24h de validade por IP
- **Performance:** M√°ximo de 45 requisi√ß√µes/minuto respeitado

#### Recursos Especiais:
- üîÑ **Auto-refresh seletivo:**
  - Stats gerais: 10s
  - Modal aberto: 3s
  - Resto da p√°gina: est√°tico
- üè† **Detec√ß√£o autom√°tica do seu IP** (pinado no topo)
- üé® **Interface escal√°vel** (testada com 100+ IPs)
- üì± **Design responsivo**
- ÔøΩ **Anima√ß√µes suaves**
- üîî **Toast notifications** (m√°x. 3 simult√¢neos)
- üåç **Bandeiras de pa√≠ses** (emojis nativos)

---

## ‚öôÔ∏è Configura√ß√£o

### Vari√°veis de Ambiente

Crie um arquivo `.env` na raiz do projeto:

```env
PORT=3000
NODE_ENV=production
```

### Configurar IPs Permitidos

Edite `src/config/allowedIPs.js`:

```javascript
module.exports = [
  '127.0.0.1',           // Localhost
  '::1',                 // Localhost IPv6
  '192.168.1.100',       // Seu IP local
  '203.0.113.0/24'       // Range de IPs (CIDR notation)
];
```

### Adicionar Schema de Valida√ß√£o

Edite `src/middlewares/validator.js`:

```javascript
const schemas = {
  cpf: Joi.object({
    cpf: Joi.string().length(11).required()
  }),
  
  // Adicione seu schema
  minhaFuncao: Joi.object({
    parametro: Joi.string().required(),
    opcional: Joi.number().optional()
  })
};
```

---

## üîí Seguran√ßa

### Controle de Acesso por IP com CIDR

O middleware `ipFilter` bloqueia automaticamente IPs n√£o autorizados com suporte a nota√ß√£o CIDR:

```javascript
// src/config/allowedIPs.js
export const allowedIPs = [
    '127.0.0.1',           // localhost IPv4
    '::1',                 // localhost IPv6
    '10.244.0.0/16',       // ZeroTier Network (65,536 IPs)
    '192.168.1.0/24',      // Rede local (256 IPs)
    ...envIPs              // IPs do .env
];
```

**Valida√ß√£o CIDR:**
- ‚úÖ Suporta ranges de IP (ex: `10.244.0.0/16`)
- ‚úÖ IPs individuais (ex: `192.168.1.100`)
- ‚úÖ IPs do arquivo `.env` (vari√°vel `ALLOWED_IPS`)

### üõ°Ô∏è Sistema de Bloqueio Autom√°tico de IPs

Sistema completo de prote√ß√£o contra tentativas de acesso n√£o autorizadas com **suspens√µes tempor√°rias** e **bloqueios permanentes**:

#### Regras de Bloqueio

```
Tentativa 1-4:  ‚ö†Ô∏è  AVISO
                "X tentativas restantes antes da suspens√£o"

Tentativa 5:    ‚è≥  SUSPENS√ÉO TEMPOR√ÅRIA (1 hora)
                HTTP 429 - "IP suspenso por 60 minutos"

Tentativa 10:   üö´  BLOQUEIO PERMANENTE
                HTTP 403 - "IP permanentemente bloqueado"
                
OU

3 Suspens√µes:   üö´  BLOQUEIO PERMANENTE
                HTTP 403 - "IP bloqueado ap√≥s 3 suspens√µes"
```

#### Configura√ß√£o Padr√£o

- **5 tentativas** ‚Üí Suspens√£o tempor√°ria (1 hora)
- **10 tentativas** ‚Üí Bloqueio permanente direto
- **3 suspens√µes** ‚Üí Bloqueio permanente
- **Cache em mem√≥ria** (Map/Set para performance)

#### Endpoints de Gerenciamento

```bash
# Estat√≠sticas gerais
GET /api/security/stats

# Listar IPs bloqueados/suspensos/avisos
GET /api/security/blocked
GET /api/security/suspended
GET /api/security/warnings

# Verificar IP espec√≠fico
GET /api/security/check/:ip

# Desbloquear IP (admin)
POST /api/security/unblock/:ip

# Remover suspens√£o (admin)
POST /api/security/unsuspend/:ip

# Obter todos os dados
GET /api/security/all
```

#### Dashboard Visual

Acesse **http://localhost:3000/logs** e expanda a se√ß√£o **"üõ°Ô∏è Sistema de Seguran√ßa"**:

- üìä Estat√≠sticas em tempo real (bloqueados/suspensos/avisos)
- üéØ Sistema de tabs moderno (Bloqueados/Suspensos/Avisos)
- üé® Cards visuais com √≠cones e detalhes completos
- ‚ö° Auto-refresh a cada 10 segundos
- üîß Bot√µes de gerenciamento (desbloquear/remover suspens√£o)
- ‚öôÔ∏è Visualiza√ß√£o das regras configuradas

**Recursos de Seguran√ßa:**
- üö´ N√£o revela como se conectar √† API
- üìù Todos os acessos negados s√£o logados
- ‚ö†Ô∏è Mensagens progressivas (aviso ‚Üí suspens√£o ‚Üí bloqueio)
- üîê Sem exposi√ß√£o de informa√ß√µes da rede interna
- ‚è∞ Suspens√µes tempor√°rias expiram automaticamente
- üõ†Ô∏è Gerenciamento completo via dashboard ou API
- üéØ Bloqueio inteligente baseado em padr√µes de comportamento

**Documenta√ß√£o Completa:** Ver [SISTEMA_BLOQUEIO.md](./SISTEMA_BLOQUEIO.md)

### Geolocaliza√ß√£o de IPs (24+ campos)

Cada acesso √© enriquecido com dados completos de geolocaliza√ß√£o (cache 24h):

```javascript
{
  ip: '203.0.113.42',
  country: 'Brazil',
  city: 'S√£o Paulo',
  countryCode: 'BR',
  region: 'SP',
  regionName: 'S√£o Paulo',
  isp: 'Example ISP',
  org: 'Example Organization',
  as: 'AS12345 Example AS',
  timezone: 'America/Sao_Paulo',
  lat: -23.5505,
  lon: -46.6333,
  hosting: false,  // √â servidor de hospedagem?
  proxy: false,    // √â proxy/VPN?
  mobile: false    // √â rede m√≥vel?
}
```

### Utilit√°rios Centralizados (ipUtils.js)

Todas as fun√ß√µes de IP est√£o centralizadas para evitar duplica√ß√£o:

```javascript
// src/utils/ipUtils.js
export function getClientIP(req) { /* ... */ }
export function cleanIP(ip) { /* ... */ }
export function isIPInRange(ip, cidr) { /* ... */ }
export function getConnectionOrigin(ip) { /* ... */ }
```

**API usada:** ip-api.com (gratuita, 45 req/min)  
**Cache:** 24 horas por IP

---

## ‚ö° Performance & Otimiza√ß√µes

### Cache Inteligente

**Geolocaliza√ß√£o (24h TTL):**
```javascript
// Cache em mem√≥ria com Map
const geoCache = new Map();
const CACHE_DURATION = 24 * 60 * 60 * 1000; // 24 horas
```
- ‚úÖ Reduz chamadas √† API externa de 45 req/min
- ‚úÖ Primeira requisi√ß√£o: ~50-100ms
- ‚úÖ Requisi√ß√µes subsequentes: ~1-2ms (cache hit)

**Rotas Descobertas (5min TTL):**
```javascript
// Cache de fun√ß√µes auto-descobertas
const CACHE_TTL = 5 * 60 * 1000; // 5 minutos
```
- ‚úÖ Evita regex repetido em cada requisi√ß√£o
- ‚úÖ Primeira chamada: ~50-100ms (leitura de arquivos)
- ‚úÖ Chamadas seguintes: ~1-2ms (cache)
- ‚úÖ Auto-atualiza√ß√£o a cada 5 minutos

### Otimiza√ß√£o O(n¬≤) ‚Üí O(n)

**Estat√≠sticas de IP otimizadas:**

Antes (O(n¬≤) - lento com muitos logs):
```javascript
// ‚ùå Iterava todos os logs para cada IP
stats.forEach(ip => {
  logs.forEach(log => { /* ... */ });
});
```

Depois (O(n) - 1000x mais r√°pido):
```javascript
// ‚úÖ Uma √∫nica passada usando Map
const stats = new Map();
for (const log of this.logs) {
  // Agrega√ß√£o em O(1)
}
```

**Ganho de Performance:**
- Com 1000 logs: De ~1.000.000 opera√ß√µes ‚Üí 1.000 opera√ß√µes
- **1000x mais r√°pido** üöÄ

### C√≥digo Sem Duplica√ß√£o

**Antes:** L√≥gica de IP duplicada em 4 arquivos  
**Depois:** Centralizada em `src/utils/ipUtils.js`

**Redu√ß√£o:** 75% menos c√≥digo duplicado  
**Manuten√ß√£o:** 4x mais f√°cil (1 lugar em vez de 4)

### CORS

CORS est√° habilitado por padr√£o para todos os origins:

```javascript
app.use(cors());
```

Para restringir origins, edite `server.js`:

```javascript
app.use(cors({
  origin: ['https://meusite.com', 'https://api.meusite.com']
}));
```

---

## ÔøΩ ZeroTier VPN - Acesso Seguro

### O que √© ZeroTier?

**ZeroTier** √© uma VPN moderna que cria redes virtuais criptografadas peer-to-peer (P2P), permitindo que dispositivos em qualquer lugar do mundo se conectem como se estivessem na mesma rede local.

#### Vantagens sobre VPNs Tradicionais:
- üîê **Criptografia Ponta-a-Ponta** - Tr√°fego totalmente criptografado
- üåê **Peer-to-Peer** - Conex√£o direta entre dispositivos (quando poss√≠vel)
- üöÄ **Baixa Lat√™ncia** - Roteamento otimizado automaticamente
- üì± **Multi-Plataforma** - Windows, Mac, Linux, iOS, Android
- üéØ **Controle Granular** - Autoriza√ß√£o por dispositivo individual
- üÜì **Gratuito** - At√© 25 dispositivos (plano gratuito)

### Como Funciona na API?

A API usa ZeroTier para controle de acesso em n√≠vel de dispositivo:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Seu PC    ‚îÇ  ‚Üê‚îÄ ZeroTier ‚îÄ‚Üí  ‚îÇ Servidor API ‚îÇ
‚îÇ 10.244.229.5‚îÇ     (VPN)         ‚îÇ 10.244.43.196‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
      ‚Üì                                  ‚Üì
  Autorizado                        Autorizado
      ‚Üì                                  ‚Üì
‚úÖ Acesso Garantido            ‚úÖ API Acess√≠vel
```

### Configura√ß√£o da Rede ZeroTier

**Range de IPs:** `10.244.0.0/16` (65,536 endere√ßos dispon√≠veis)

```javascript
// src/config/allowedIPs.js
export const allowedIPs = [
    '127.0.0.1',           // localhost IPv4
    '::1',                 // localhost IPv6
    '10.244.0.0/16',       // ‚úÖ ZeroTier Network (todos os dispositivos autorizados)
    ...envIPs              // IPs adicionais do .env
];
```

**Valida√ß√£o CIDR Inteligente:**
- ‚úÖ Todo IP no range `10.244.0.0/16` √© automaticamente autorizado
- ‚úÖ Suporta at√© 65.536 dispositivos diferentes
- ‚úÖ Autoriza√ß√£o gerenciada pelo dashboard ZeroTier

### Detec√ß√£o Autom√°tica de ZeroTier

O middleware `ipFilter` detecta automaticamente quando um cliente est√° conectado via ZeroTier:

```javascript
// src/utils/ipUtils.js
export function getConnectionOrigin(ip) {
    if (ip.startsWith('10.244.')) {
        return {
            type: 'zerotier',
            network: 'ZeroTier VPN',
            icon: 'üîê',
            color: 'green'
        };
    }
    // ... outras detec√ß√µes
}
```

**Logs Amig√°veis:**
```
================================================================================
üîê IP FILTER - CLIENT ACCESS ATTEMPT
================================================================================
‚è∞ Time: 2025-10-17T12:00:00.000Z

üìç IP ANALYSIS:
   üéØ Detected (used for auth): 10.244.229.5
   üîê Origin: ZeroTier VPN (zerotier)

üîê ZEROTIER INFO:
   Network: fada62b01530e6b6
   Range: 10.244.0.0/16
   Security: Encrypted P2P connection

‚úÖ AUTHORIZATION: ‚úÖ YES - ACCESS GRANTED
================================================================================
```

### Endpoints ZeroTier

#### GET `/zerotier/status`
Retorna informa√ß√µes sobre a conex√£o ZeroTier do cliente:

```json
{
  "success": true,
  "client": {
    "ip": "10.244.229.5",
    "isZeroTier": true,
    "network": "ZeroTier VPN (10.244.0.0/16)",
    "authorized": true,
    "icon": "üîê"
  },
  "server": {
    "zerotierNetwork": {
      "networkId": "fada62b01530e6b6",
      "networkName": "API Private Network",
      "range": "10.244.0.0/16",
      "features": [
        "Criptografia ponta-a-ponta",
        "Controle de acesso por dispositivo",
        "IP fixo independente da rede f√≠sica",
        "Baixa lat√™ncia (P2P quando poss√≠vel)"
      ]
    }
  },
  "message": "üîê Conectado via ZeroTier - Conex√£o segura e criptografada!"
}
```

#### GET `/zerotier/devices`
Informa√ß√µes sobre dispositivos (simulado):

```json
{
  "success": true,
  "network": {
    "id": "fada62b01530e6b6",
    "name": "API Private Network",
    "range": "10.244.0.0/16"
  },
  "note": "Para ver a lista completa de dispositivos, acesse: https://my.zerotier.com/",
  "yourIP": "10.244.229.5"
}
```

### Benef√≠cios de Usar ZeroTier

1. **Seguran√ßa em M√∫ltiplas Camadas:**
   - ‚úÖ VPN criptografada (criptografia de transporte)
   - ‚úÖ Controle de acesso por dispositivo (autoriza√ß√£o)
   - ‚úÖ IP whitelist com CIDR (valida√ß√£o)

2. **Flexibilidade:**
   - ‚úÖ Acesse de qualquer lugar do mundo
   - ‚úÖ IP fixo mesmo mudando de rede f√≠sica
   - ‚úÖ Suporte a dispositivos m√≥veis (iOS/Android)

3. **Performance:**
   - ‚úÖ Conex√£o P2P direta quando poss√≠vel
   - ‚úÖ Baixa lat√™ncia (geralmente <50ms)
   - ‚úÖ Sem gargalo de servidor VPN central

4. **Facilidade de Gerenciamento:**
   - ‚úÖ Dashboard web para gerenciar dispositivos
   - ‚úÖ Autoriza√ß√£o/revoga√ß√£o instant√¢nea
   - ‚úÖ Visibilidade de todos os dispositivos conectados

### Documenta√ß√£o Adicional

Para documenta√ß√£o completa sobre a implementa√ß√£o ZeroTier, consulte:

- **Setup Guide:** `ZEROTIER_SETUP.md` (guia de instala√ß√£o detalhado)
- **Implementation:** `IMPLEMENTACAO_ZEROTIER_COMPLETA.md` (detalhes t√©cnicos)
- **Planning:** `PLANO_IMPLEMENTACAO_ZEROTIER.md` (planejamento em 5 fases)

---

## üÜï Novas Implementa√ß√µes (v2.1.0+)

### ‚ö° Otimiza√ß√µes de Performance

1. **Cache Inteligente de Rotas (5min TTL)**
   - GET `/api/functions` agora usa cache
   - Primeira chamada: ~50-100ms
   - Chamadas subsequentes: ~1-2ms (50x mais r√°pido)

2. **Estat√≠sticas de IP Otimizadas (O(n¬≤) ‚Üí O(n))**
   - `getIPStats()` reescrito com Map
   - 1000x mais r√°pido com 1000+ logs
   - Uso de `for...of` em vez de `forEach`

3. **Cache de Geolocaliza√ß√£o (24h TTL)**
   - Reduz chamadas √† API externa
   - Respeita limite de 45 req/min
   - Performance consistente

### üßπ Refatora√ß√£o e Limpeza de C√≥digo

1. **Utilit√°rios Centralizados (`ipUtils.js`)**
   - `getClientIP(req)` - Extra√ß√£o de IP real
   - `cleanIP(ip)` - Limpeza de prefixos IPv6
   - `isIPInRange(ip, cidr)` - Valida√ß√£o CIDR
   - `getConnectionOrigin(ip)` - Detec√ß√£o de origem
   - **Redu√ß√£o:** 75% menos c√≥digo duplicado

2. **Corre√ß√£o de Bugs Cr√≠ticos**
   - ‚úÖ Bug em `allowedIPs.js` (spread operator comentado)
   - ‚úÖ Caminho incorreto de `pdfParseWrapper.cjs`
   - ‚úÖ Depend√™ncias circulares eliminadas

### üîí Melhorias de Seguran√ßa

1. **Prote√ß√£o Anti-Hacking**
   - Mensagens de advert√™ncia para IPs n√£o autorizados
   - Sem exposi√ß√£o de informa√ß√µes sens√≠veis
   - Logging de todas as tentativas de acesso

2. **Resposta Rica para Autorizados**
   - GET `/` expandido de 5 para 40+ campos
   - Informa√ß√µes de API, cliente, IP, features
   - Quick links mantidos e expandidos

3. **Suporte a CIDR Nativo**
   - Valida√ß√£o de ranges de IP (ex: `10.244.0.0/16`)
   - Suporta IPv4 com m√°scaras de rede
   - Algoritmo otimizado de valida√ß√£o

---

## ÔøΩüìÅ Estrutura do Projeto

```
api/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ config/              # Configura√ß√µes centralizadas
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ allowedIPs.js    # Lista de IPs permitidos
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.js         # Exportador de configs
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ core/                # Componentes centrais
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ BaseController.js  # Controller base
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ routeLoader.js     # Auto-carregador de rotas
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ functions/           # Funcionalidades modulares
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ _TEMPLATE/       # Template para novas funcionalidades
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ templateController.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ templateRoutes.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ templateUtils.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ README.md
‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ exemplo/         # Exemplo (CRUD de usu√°rios)
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ exemploController.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ exemploRoutes.js
‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ pdf/             # Processamento de PDFs
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ pdfController.js
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ pdfRoutes.js
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ pdfParseWrapper.cjs  # Wrapper CommonJS (modular)
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ README.md
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ middlewares/         # Middlewares globais
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ errorHandler.js  # Tratamento de erros
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ipFilter.js      # Filtro de IP + geolocaliza√ß√£o
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ validator.js     # Valida√ß√£o de schemas
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ routes/              # Rotas especiais
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ docs.js          # Documenta√ß√£o HTML interativa
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ index.js         # Rota raiz (JSON)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ logsDashboard.js # Dashboard de logs em tempo real
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ logsRoutes.js    # API de logs (com cache)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ securityRoutes.js # API de seguran√ßa (bloqueios)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ zerotier.js      # Status ZeroTier VPN
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ utils/               # Utilit√°rios gen√©ricos
‚îÇ       ‚îú‚îÄ‚îÄ accessLogger.js  # Logger de acessos (otimizado O(n))
‚îÇ       ‚îú‚îÄ‚îÄ ipUtils.js       # Utilit√°rios de IP (CIDR, detec√ß√£o)
‚îÇ       ‚îî‚îÄ‚îÄ ipBlockingSystem.js  # Sistema de bloqueio autom√°tico
‚îÇ
‚îú‚îÄ‚îÄ server.js                # Entry point
‚îú‚îÄ‚îÄ package.json             # Depend√™ncias (v2.1.0)
‚îú‚îÄ‚îÄ README.md                # Documenta√ß√£o principal
‚îú‚îÄ‚îÄ SISTEMA_BLOQUEIO.md      # Documenta√ß√£o do sistema de bloqueio
‚îú‚îÄ‚îÄ IMPLEMENTACAO_BLOQUEIO.md # Resumo executivo da implementa√ß√£o
‚îî‚îÄ‚îÄ AUDITORIA_COMPLETA.md    # Relat√≥rio de auditoria
```

---

## ü§ù Contribuindo

Contribui√ß√µes s√£o bem-vindas! Siga estes passos:

1. **Fork o projeto**
2. **Crie uma branch para sua feature:**
   ```bash
   git checkout -b feature/minha-feature
   ```
3. **Commit suas mudan√ßas:**
   ```bash
   git commit -m 'Adiciona minha feature'
   ```
4. **Push para a branch:**
   ```bash
   git push origin feature/minha-feature
   ```
5. **Abra um Pull Request**

---

## üìÑ Licen√ßa

Este projeto est√° sob a licen√ßa **MIT**. Veja o arquivo [LICENSE](LICENSE) para mais detalhes.

---

## üéâ Cr√©ditos

Desenvolvido com ‚ù§Ô∏è por [Gilberto Roman Holew](https://github.com/gilbertoromanholew)

**URL de Produ√ß√£o:** https://api.samm.host

---

## üìû Suporte

Encontrou algum problema? Abra uma [issue](https://github.com/gilbertoromanholew/api/issues) no GitHub.

---

**‚≠ê Se este projeto foi √∫til, deixe uma estrela no GitHub!**

# üîí Auditoria de Seguran√ßa - API v2.10.4

**Data:** 17 de outubro de 2025  
**Auditor:** GitHub Copilot  
**Escopo:** An√°lise completa de vulnerabilidades por n√≠vel de acesso

---

## üìã Resumo Executivo

| M√©trica | Valor |
|---------|-------|
| **Vulnerabilidades Cr√≠ticas** | 2 üî¥ |
| **Vulnerabilidades Altas** | 3 üü† |
| **Vulnerabilidades M√©dias** | 2 üü° |
| **Vulnerabilidades Baixas** | 1 üü¢ |
| **Score de Seguran√ßa** | 6.5/10 ‚ö†Ô∏è |

---

## üéØ Hierarquia de Acesso Atual

### 1. **UNAUTHORIZED** (N√£o Autorizado)
- IPs n√£o reconhecidos
- Bloqueados pelo `ipFilter`
- **Status:** ‚úÖ SEGURO

### 2. **GUEST** (Convidado)
- IPs autorizados temporariamente
- **Acesso Esperado:** `/`, `/docs`, endpoints de functions
- **Acesso Real:** ‚ö†Ô∏è VER VULNERABILIDADES ABAIXO

### 3. **TRUSTED** (Confi√°vel)
- IPs do `.env` (ALLOWED_IPS)
- **Acesso Esperado:** Mesmo que GUEST + algumas APIs extras
- **Acesso Real:** ‚ö†Ô∏è VER VULNERABILIDADES ABAIXO

### 4. **ADMIN** (Administrador)
- `127.0.0.1`, `::1`, `10.244.0.0/16` (ZeroTier)
- **Acesso Esperado:** TUDO
- **Acesso Real:** ‚úÖ CORRETO

---

## üö® VULNERABILIDADES CR√çTICAS

### üî¥ VULN-001: Exposi√ß√£o da API de Logs (CORRIGIDA na v2.10.4)

**Gravidade:** üî¥ CR√çTICA  
**Status:** ‚úÖ **CORRIGIDA**  
**Afeta:** GUEST, TRUSTED

**Descri√ß√£o:**  
As rotas `/api/logs/*` estavam completamente abertas antes da v2.10.4, permitindo que qualquer IP autorizado (guest/trusted) acessasse logs sens√≠veis.

**Explora√ß√£o:**
```bash
# Como GUEST, era poss√≠vel:
curl https://api.samm.host/api/logs?ip=127.0.0.1
curl https://api.samm.host/api/logs/stats
curl https://api.samm.host/api/logs/ips
curl -X POST https://api.samm.host/api/logs/clear  # LIMPAR TODOS OS LOGS!
```

**Dados Expostos:**
- Todos os IPs que acessaram a API
- Timestamps, endpoints, m√©todos HTTP
- Geolocaliza√ß√£o de todos os clientes
- Estat√≠sticas completas de acesso
- **Possibilidade de LIMPAR logs (POST /clear)**

**Corre√ß√£o Aplicada (v2.10.4):**
```javascript
// server.js - LINHA 104
app.use('/api/logs', requireAdmin, logsRoutes);  // ‚úÖ Protegida
```

**Impacto:** ‚úÖ Resolvido - Apenas ADMIN pode acessar logs

---

### üî¥ VULN-002: ipFilter n√£o define req.ip_detected e req.accessLevel

**Gravidade:** üî¥ CR√çTICA  
**Status:** ‚ùå **N√ÉO CORRIGIDA**  
**Afeta:** Todos os n√≠veis

**Descri√ß√£o:**  
O middleware `ipFilter` valida se o IP est√° autorizado, mas **N√ÉO define** as vari√°veis `req.ip_detected` e `req.accessLevel` que outros middlewares esperam.

**Localiza√ß√£o:**  
`src/middlewares/ipFilter.js` - Linha 283 (apenas chama `next()` sem definir vari√°veis)

**C√≥digo Problem√°tico:**
```javascript
// ipFilter.js - LINHA 283
if (!clientInfo.is_authorized) {
    // ... c√≥digo de bloqueio
}

next(); // ‚ùå N√£o define req.ip_detected nem req.accessLevel
```

**Middlewares Afetados:**
```javascript
// accessLevel.js - LINHA 115
const ip = req.ip_detected || req.ip;  // ‚ö†Ô∏è Sempre vai usar req.ip

// accessLevel.js - LINHA 164
const ip = req.ip_detected || req.ip;  // ‚ö†Ô∏è Sempre vai usar req.ip
```

**Impacto:**
- Middlewares de autoriza√ß√£o podem pegar IP errado (req.ip em vez de clientIp detectado)
- N√£o h√° rastreamento consistente do n√≠vel de acesso entre middlewares
- Dificulta auditoria e logs de seguran√ßa

**Corre√ß√£o Necess√°ria:**
```javascript
// ipFilter.js - ANTES DE next()
req.ip_detected = clientIp;
req.accessLevel = 'unauthorized'; // Ser√° sobrescrito por requireAdmin/etc
req.clientInfo = clientInfo;

next();
```

---

## üü† VULNERABILIDADES ALTAS

### üü† VULN-003: /api/functions exp√µe estrutura de diret√≥rios

**Gravidade:** üü† ALTA  
**Status:** ‚ùå **N√ÉO CORRIGIDA**  
**Afeta:** GUEST, TRUSTED, ADMIN (rota p√∫blica)

**Descri√ß√£o:**  
A rota `/api/functions` em `server.js` (linhas 36-100) l√™ o sistema de arquivos e exp√µe:
- Nomes de todas as pastas em `src/functions/`
- Conte√∫do de README.md
- Todas as rotas e m√©todos HTTP de cada fun√ß√£o
- Estrutura de c√≥digo (via regex `router.(get|post|put|delete|patch)`)

**Explora√ß√£o:**
```bash
curl https://api.samm.host/api/functions
```

**Resposta (exemplo):**
```json
{
  "success": true,
  "total": 2,
  "functions": [
    {
      "name": "exemplo",
      "path": "/exemplo",
      "description": "CRUD de usu√°rios",
      "endpoints": [
        { "method": "GET", "path": "/usuarios" },
        { "method": "POST", "path": "/usuarios" },
        { "method": "PUT", "path": "/usuarios/:id" },
        { "method": "DELETE", "path": "/usuarios/:id" }
      ]
    },
    {
      "name": "pdf",
      "path": "/pdf",
      "endpoints": [
        { "method": "POST", "path": "/read-pdf" }
      ]
    }
  ]
}
```

**Risco:**
- Revela toda a superf√≠cie de ataque
- Facilita enumera√ß√£o de endpoints
- Exp√µe informa√ß√µes de arquitetura interna

**N√≠vel Atual:** üîì **P√öBLICO** (sem prote√ß√£o)

**Corre√ß√£o Recomendada:**
```javascript
// server.js - LINHA 36
app.get('/api/functions', requireAdmin, async (req, res) => {
    // ... c√≥digo existente
});
```

**Alternativa:** Manter p√∫blico mas remover informa√ß√µes sens√≠veis (s√≥ mostrar nomes, sem estrutura de rotas)

---

### üü† VULN-004: Rotas de Functions sem controle de n√≠vel de acesso

**Gravidade:** üü† ALTA  
**Status:** ‚ùå **N√ÉO CORRIGIDA**  
**Afeta:** GUEST pode acessar TODAS as rotas de functions

**Descri√ß√£o:**  
As rotas carregadas dinamicamente de `src/functions/` s√£o registradas **SEM** valida√ß√£o de n√≠vel de acesso:

```javascript
// routeLoader.js - LINHA 46
app.use(routeModule.default);  // ‚ùå SEM PROTE√á√ÉO!
```

**Rotas Expostas:**
- `/usuarios` (GET, POST, PUT, DELETE) - GUEST tem acesso total!
- `/usuarios/:id` - GUEST pode criar, editar, deletar
- `/read-pdf` - GUEST pode fazer upload e processar PDFs

**Comportamento Esperado vs Real:**

| A√ß√£o | Esperado | Real |
|------|----------|------|
| Guest GET /usuarios | ‚úÖ Permitido (leitura) | ‚úÖ Permitido |
| Guest POST /usuarios | ‚ùå Negado (escrita) | ‚úÖ **PERMITIDO** üö® |
| Guest PUT /usuarios/:id | ‚ùå Negado (escrita) | ‚úÖ **PERMITIDO** üö® |
| Guest DELETE /usuarios/:id | ‚ùå Negado (delete) | ‚úÖ **PERMITIDO** üö® |
| Guest POST /read-pdf | ‚ùå Negado (upload) | ‚úÖ **PERMITIDO** üö® |

**Impacto:**
- GUEST pode modificar dados (POST, PUT, DELETE)
- GUEST pode fazer upload de arquivos (PDF)
- Sem controle granular de permiss√µes

**Corre√ß√£o Necess√°ria:**

**Op√ß√£o 1: Prote√ß√£o Global (Simples)**
```javascript
// server.js - ANTES de autoLoadRoutes
app.use('/usuarios', requireTrusted);  // Apenas trusted+ pode acessar
app.use('/read-pdf', requireTrusted);
```

**Op√ß√£o 2: Middleware de Valida√ß√£o (Recomendado)**
```javascript
// server.js - LINHA 23 (depois de ipFilter)
import { validateRouteAccess } from './src/middlewares/accessLevel.js';
app.use(validateRouteAccess);  // Valida TODA requisi√ß√£o
```

**Op√ß√£o 3: Por M√©todo HTTP (Mais Granular)**
```javascript
// exemploRoutes.js
import { requireTrusted } from '../../middlewares/accessLevel.js';

router.get('/usuarios', exemploController.listarUsuarios);  // Guest OK
router.post('/usuarios', requireTrusted, exemploController.criarUsuario);  // Trusted+
router.put('/usuarios/:id', requireTrusted, exemploController.atualizarUsuario);
router.delete('/usuarios/:id', requireAdmin, exemploController.deletarUsuario);  // Admin only
```

---

### üü† VULN-005: /zerotier exp√µe Network ID p√∫blico

**Gravidade:** üü† ALTA  
**Status:** ‚ùå **N√ÉO CORRIGIDA**  
**Afeta:** TODOS (rota p√∫blica)

**Descri√ß√£o:**  
A rota `/zerotier/status` √© p√∫blica e exp√µe:
- Network ID completo: `fada62b01530e6b6`
- Range da rede: `10.244.0.0/16`
- Gateway: `25.255.255.254`
- Instru√ß√µes completas de como se conectar

**Explora√ß√£o:**
```bash
curl https://api.samm.host/zerotier/status
```

**Risco:**
- Qualquer pessoa pode tentar se conectar √† rede ZeroTier
- Mesmo que n√£o seja autorizado no dashboard, j√° sabe o Network ID
- Facilita tentativas de bruteforce ou engenharia social

**Localiza√ß√£o:**  
`src/routes/zerotier.js` - Todo o arquivo √© p√∫blico

**Corre√ß√£o Recomendada:**
```javascript
// server.js - LINHA 105
app.use('/zerotier', requireAdmin, zerotierRoutes);  // ‚úÖ Proteger
```

**OU** (se quiser manter info b√°sica p√∫blica):
```javascript
// zerotier.js - Remover Network ID e gateway
const networkInfo = {
    // networkId: 'fada62b01530e6b6',  // ‚ùå REMOVER
    networkName: 'API Private Network',
    range: '10.244.0.0/16',  // OK manter (√© padr√£o)
    // gateway: '25.255.255.254',  // ‚ùå REMOVER
    description: 'Rede virtual segura para acesso √† API'
};
```

---

## üü° VULNERABILIDADES M√âDIAS

### üü° VULN-006: trackViolations n√£o registra todas as tentativas

**Gravidade:** üü° M√âDIA  
**Status:** ‚ùå **N√ÉO CORRIGIDA**  
**Afeta:** Auditoria de seguran√ßa

**Descri√ß√£o:**  
O middleware `trackViolations` (accessLevel.js, linha 188) s√≥ rastreia erros 403, mas **n√£o rastreia**:
- Tentativas de acesso a rotas inexistentes (404)
- Erros de valida√ß√£o (400)
- Tentativas de m√©todos n√£o permitidos (405)
- Rate limiting (429)

**Impacto:**
- Auditoria incompleta
- Dif√≠cil detectar padr√µes de ataque
- Viola√ß√µes n√£o registradas no sistema de bloqueio

**Corre√ß√£o Recomendada:**
```javascript
// accessLevel.js - trackViolations
res.json = async function(data) {
    // Rastrear 403, 401, 404, 400, 405, 429
    if ([403, 401, 404, 400, 405, 429].includes(res.statusCode) && !data.success) {
        // ... c√≥digo de rastreamento
    }
    return originalJson(data);
};
```

---

### üü° VULN-007: CORS totalmente aberto

**Gravidade:** üü° M√âDIA  
**Status:** ‚ùå **N√ÉO CORRIGIDA**  
**Afeta:** Todos

**Descri√ß√£o:**  
CORS est√° configurado sem restri√ß√µes:

```javascript
// server.js - LINHA 18
app.use(cors());  // ‚ùå Aceita qualquer origem
```

**Risco:**
- Qualquer site pode fazer requisi√ß√µes √† API
- Facilita ataques CSRF (Cross-Site Request Forgery)
- Permite embedding da API em sites maliciosos

**Corre√ß√£o Recomendada:**
```javascript
// server.js
app.use(cors({
    origin: [
        'https://api.samm.host',
        'http://localhost:3000',
        /^http:\/\/10\.244\.\d+\.\d+:\d+$/  // ZeroTier range
    ],
    credentials: true,
    methods: ['GET', 'POST', 'PUT', 'DELETE', 'PATCH'],
    allowedHeaders: ['Content-Type', 'Authorization']
}));
```

---

## üü¢ VULNERABILIDADES BAIXAS

### üü¢ VULN-008: Documenta√ß√£o exp√µe informa√ß√µes de vers√£o

**Gravidade:** üü¢ BAIXA  
**Status:** ‚ùå **N√ÉO CORRIGIDA**  
**Afeta:** Todos (informacional)

**Descri√ß√£o:**  
Rotas `/` e `/docs` exp√µem:
- Vers√£o do Node.js
- Uptime do servidor
- Ambiente (production/dev)
- Estrutura completa da API

**Localiza√ß√£o:**  
`src/routes/index.js` - linha 47

**Risco:**
- Facilita fingerprinting
- Pode revelar vulnerabilidades conhecidas da vers√£o do Node
- Informa√ß√µes √∫teis para reconhecimento

**Corre√ß√£o (Opcional):**
```javascript
// index.js - Remover ou proteger
api: {
    name: 'API Modular',
    version: '2.10.4',  // ‚ùå Remover em produ√ß√£o
    status: 'online',
    // environment: process.env.NODE_ENV,  // ‚ùå Remover
    // node_version: process.version,  // ‚ùå Remover
    // uptime: process.uptime()  // ‚ùå Remover
}
```

---

## ‚úÖ CORRE√á√ïES RECOMENDADAS (Prioridade)

### üî• URGENTE (Implementar Agora)

1. **VULN-002:** Definir `req.ip_detected` e `req.accessLevel` no ipFilter
2. **VULN-004:** Proteger rotas de escrita em functions (POST, PUT, DELETE)
3. **VULN-005:** Proteger `/zerotier` ou remover Network ID

### üî∂ ALTA (Implementar Esta Semana)

4. **VULN-003:** Proteger `/api/functions` com requireAdmin
5. **VULN-007:** Configurar CORS restrito

### üî∑ M√âDIA (Implementar Este M√™s)

6. **VULN-006:** Expandir trackViolations para todos os erros
7. **VULN-008:** Remover informa√ß√µes de vers√£o em produ√ß√£o

---

## üìä Matriz de Acesso Atual vs Esperada

### ‚ùå ATUAL (Com Vulnerabilidades)

| Rota | UNAUTH | GUEST | TRUSTED | ADMIN |
|------|--------|-------|---------|-------|
| `/` | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| `/docs` | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| `/logs` | ‚ùå | ‚ùå | ‚ùå | ‚úÖ |
| `/api/logs/*` | ‚ùå | ‚ùå | ‚ùå | ‚úÖ ‚úÖ |
| `/api/security/*` | ‚ùå | ‚ùå | ‚ùå | ‚úÖ |
| `/api/functions` | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ ‚ö†Ô∏è |
| `/zerotier/*` | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ ‚ö†Ô∏è |
| `GET /usuarios` | ‚ùå | ‚úÖ | ‚úÖ | ‚úÖ |
| `POST /usuarios` | ‚ùå | ‚úÖ üö® | ‚úÖ | ‚úÖ |
| `PUT /usuarios/:id` | ‚ùå | ‚úÖ üö® | ‚úÖ | ‚úÖ |
| `DELETE /usuarios/:id` | ‚ùå | ‚úÖ üö® | ‚úÖ | ‚úÖ |
| `POST /read-pdf` | ‚ùå | ‚úÖ üö® | ‚úÖ | ‚úÖ |

### ‚úÖ ESPERADA (Ap√≥s Corre√ß√µes)

| Rota | UNAUTH | GUEST | TRUSTED | ADMIN |
|------|--------|-------|---------|-------|
| `/` | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| `/docs` | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| `/logs` | ‚ùå | ‚ùå | ‚ùå | ‚úÖ |
| `/api/logs/*` | ‚ùå | ‚ùå | ‚ùå | ‚úÖ |
| `/api/security/*` | ‚ùå | ‚ùå | ‚ùå | ‚úÖ |
| `/api/functions` | ‚ùå | ‚ùå | ‚ùå | ‚úÖ ‚úÖ |
| `/zerotier/*` | ‚ùå | ‚ùå | ‚ùå | ‚úÖ ‚úÖ |
| `GET /usuarios` | ‚ùå | ‚úÖ | ‚úÖ | ‚úÖ |
| `POST /usuarios` | ‚ùå | ‚ùå | ‚úÖ ‚úÖ | ‚úÖ |
| `PUT /usuarios/:id` | ‚ùå | ‚ùå | ‚úÖ ‚úÖ | ‚úÖ |
| `DELETE /usuarios/:id` | ‚ùå | ‚ùå | ‚ùå | ‚úÖ ‚úÖ |
| `POST /read-pdf` | ‚ùå | ‚ùå | ‚úÖ ‚úÖ | ‚úÖ |

---

## üéØ Plano de A√ß√£o

### Fase 1: Corre√ß√µes Cr√≠ticas (Hoje)
```bash
# 1. Corrigir ipFilter
# src/middlewares/ipFilter.js - Adicionar antes de next()
req.ip_detected = clientIp;
req.clientInfo = clientInfo;

# 2. Proteger rotas de escrita
# src/functions/exemplo/exemploRoutes.js
import { requireTrusted } from '../../middlewares/accessLevel.js';
router.post('/usuarios', requireTrusted, ...);
router.put('/usuarios/:id', requireTrusted, ...);
router.delete('/usuarios/:id', requireAdmin, ...);

# 3. Proteger /zerotier
# server.js
app.use('/zerotier', requireAdmin, zerotierRoutes);
```

### Fase 2: Corre√ß√µes Altas (Esta Semana)
```bash
# 4. Proteger /api/functions
# server.js - linha 36
app.get('/api/functions', requireAdmin, async (req, res) => { ... });

# 5. Configurar CORS
# server.js - linha 18
app.use(cors({ origin: [...], credentials: true }));
```

### Fase 3: Melhorias (Este M√™s)
```bash
# 6. Expandir trackViolations
# 7. Limpar informa√ß√µes de vers√£o
```

---

## üìà Score de Seguran√ßa

### Antes das Corre√ß√µes: 6.5/10 ‚ö†Ô∏è
- ‚ùå 2 vulnerabilidades cr√≠ticas
- ‚ùå 3 vulnerabilidades altas
- ‚ö†Ô∏è 2 vulnerabilidades m√©dias
- ‚ÑπÔ∏è 1 vulnerabilidade baixa

### Ap√≥s Corre√ß√µes Urgentes: 8.0/10 üü¢
- ‚úÖ Vulnerabilidades cr√≠ticas corrigidas
- ‚úÖ Principais vulnerabilidades altas corrigidas
- ‚ö†Ô∏è Algumas vulnerabilidades m√©dias pendentes

### Ap√≥s Todas as Corre√ß√µes: 9.5/10 üåü
- ‚úÖ Todas as vulnerabilidades corrigidas
- ‚úÖ Sistema de permiss√µes robusto
- ‚úÖ Auditoria completa
- ‚úÖ CORS configurado
- ‚úÖ Sem vazamento de informa√ß√µes

---

## üìù Notas Finais

**Pontos Positivos:**
- ‚úÖ Sistema de bloqueio autom√°tico funcionando
- ‚úÖ Valida√ß√£o de IP com CIDR implementada
- ‚úÖ Geolocaliza√ß√£o e logs detalhados
- ‚úÖ Dashboard protegido corretamente

**Pontos de Aten√ß√£o:**
- ‚ö†Ô∏è Falta de controle granular de permiss√µes em functions
- ‚ö†Ô∏è Exposi√ß√£o desnecess√°ria de informa√ß√µes (Network ID, estrutura)
- ‚ö†Ô∏è CORS totalmente aberto

**Recomenda√ß√£o Final:**
Implementar **Fase 1 (Urgente)** imediatamente para elevar o score de 6.5 para 8.0. As vulnerabilidades cr√≠ticas encontradas permitem que usu√°rios GUEST modifiquem dados e acessem informa√ß√µes sens√≠veis da rede.

---

**Pr√≥xima Auditoria:** Ap√≥s implementa√ß√£o das corre√ß√µes (v2.11.0)
